# 開発計画

## ゴール
- 「効き水」実験結果を学生が入力し、教員が統計的に把握できる完全フロントエンドのWebアプリを提供する。
- 入力ページでドラッグ＆ドロップによる順位回答と学籍番号（任意）を受け付け、クラウドへ保存する。
- 集計ページで混同行列・散布図・Spearman順位相関係数ヒストグラム・二項検定を可視化し、授業内で即利用できる形にする。

## 想定技術スタック
- Vite + React + TypeScript（開発体験と型安全性のバランス）
- 状態管理：React Query（Firestoreとの同期を簡潔に）
- UI：Tailwind CSS（素早いスタイリング）＋ Headless UI（アクセシブルなコンポーネント）
- DnD：`@dnd-kit/core`
- チャート：Chart.js + `react-chartjs-2`
- データストア：Firebase Firestore（完全フロントエンド構成での認証レス匿名書き込みをルール制御）
- デプロイ：Vercel or Netlify（環境変数でFirebase設定を注入）

## データモデル
| フィールド       | 型        | 説明                                   |
|------------------|-----------|----------------------------------------|
| `studentId`      | string?   | 任意入力。未入力時は `null` 保存。      |
| `order`          | string[4] | A, B, C, D の並び順。                   |
| `timestamp`      | number    | `Date.now()`。                          |
| `hardnessRanks`* | number[4] | 実験水の真の硬度順位（教師データ）。   |

\* `hardnessRanks` は結果計算用に別コレクション or コンフィグで保持。

## 画面別機能
### 入力ページ `/index.html`
- DnDで順位を決めるカード UI、順位番号のビジュアル表示。
- 学籍番号は任意・フォーマット簡易バリデーション。
- 送信時：入力検証 → Firestore へ書き込み → 成功後に `/results.html` へ遷移。
- エラー時：トースト表示／リトライ誘導。

### 集計ページ `/results.html`
- Firestore から全回答を取得し、React Query でキャッシュ。
- 集計ロジック
  - 混同行列：実順位 vs. 回答順位のカウントマトリクス。
  - 散布図：真の硬度順位を x、平均回答順位を y にした点群。
  - Spearman 順位相関係数：個々の提出に対して算出しヒストグラム描画。
  - 二項検定：正答（完全一致）と誤答の比率から p 値算出し表示。
- 更新監視：`onSnapshot` などでリアルタイム更新 or 定期ポーリング。

## 実装ステップ
1. **初期セットアップ**  
   - Vite + React + TS で雛形作成、ESLint/Prettier/Vitest 導入。  
   - Firebase プロジェクトを作成し環境変数を `.env` に配置。
2. **共通基盤整備**  
   - 型（`Submission`, `HardnessConfig` など）とユーティリティ（順位変換、Spearman、二項検定関数）を実装。  
   - Firebase 初期化モジュールとセキュリティルール（匿名書き込み制限 + 読み取り制御）を設定。
3. **入力ページ実装**  
   - DnD UI（`@dnd-kit`）を組み込み、順位変更時の状態更新。  
   - 入力フォーム、送信処理、バリデーション、送信後遷移を実装。
4. **集計ページ実装**  
   - Firestore 取得ロジック・React Query。  
   - 混同行列・散布図・ヒストグラム・統計値計算をコンポーネント化。  
   - ローディング／エラー表示とフィルタ（例：期間指定）を追加。
5. **テストと品質保証**  
   - ユニットテスト：順位計算・統計関数。  
   - E2E（Playwright）：入力→保存→集計表示のハッピーパス。  
   - アクセシビリティ確認（キーボード操作、コントラスト）。  
   - パフォーマンス計測（Lighthouse）。
6. **リリース準備**  
   - CI（GitHub Actions）で lint/test/build。  
   - Vercel/Netlify へデプロイ、プレビュー URL で最終確認。  
   - Firestore ルールの本番適用、授業用サンプルデータ投入。

## スケジュール案（2 週間スプリント）
| 期間          | 作業内容                                             |
|---------------|------------------------------------------------------|
| Day 1-2       | 開発環境構築・Firebase 設定・デザインスケッチ         |
| Day 3-5       | 入力ページ UI/送信処理・単体テスト                    |
| Day 6-8       | 集計ロジック実装・チャート描画                        |
| Day 9-10      | 統計テスト実装・リアルタイム更新                     |
| Day 11-12     | E2E/A11y テスト・フィードバック反映                  |
| Day 13-14     | 本番ビルド・デプロイ・ドキュメント整備               |

## リスクと対応
- **匿名書き込みのスパム**：Firestore セキュリティルールでレート制限、Recaptcha v3 導入検討。
- **統計処理の信頼性**：テストケースで既知データとの突き合わせ＋計算式コメント化。
- **授業内ネットワーク不調**：オフライン時のローカル保存＆後送信キューイングを後続機能として検討。
