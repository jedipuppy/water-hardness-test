<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>サイコロシミュレーター</title>
    <style>
      :root {
        font-family: "Segoe UI", "Hiragino Sans", "Meiryo", sans-serif;
        color-scheme: light dark;
        --surface: rgba(255, 255, 255, 0.9);
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --shadow: rgba(15, 23, 42, 0.16);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, #dbeafe, #f8fafc 70%);
      }

      main {
        width: min(720px, 94vw);
        padding: clamp(1.6rem, 4vw, 2.8rem);
        border-radius: 20px;
        background: var(--surface);
        box-shadow: 0 30px 70px -40px var(--shadow);
        display: grid;
        gap: clamp(1.4rem, 3vw, 2.2rem);
      }

      h1 {
        margin: 0;
        font-size: clamp(1.6rem, 4vw, 2.4rem);
        text-align: center;
        color: var(--primary-dark);
      }

      .dice-board {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: clamp(1.4rem, 4vw, 2.2rem);
        perspective: 900px;
      }

      .die {
        width: clamp(68px, 22vw, 110px);
        aspect-ratio: 1 / 1;
        border-radius: 18px;
        background: radial-gradient(circle at 40% 40%, #fff 0%, #f8fafc 55%, #e2e8f0 100%);
        box-shadow: 0 18px 36px -26px rgba(15, 23, 42, 0.55),
          inset 2px 2px 6px rgba(255, 255, 255, 0.6),
          inset -2px -4px 8px rgba(148, 163, 184, 0.6);
        position: relative;
        transform: translateZ(0);
        transition: box-shadow 0.3s ease;
      }

      .die-face {
        position: absolute;
        inset: clamp(0.55rem, 1.4vw, 0.9rem);
        border-radius: inherit;
        display: grid;
      }

      .die.is-rolling {
        animation: roll-spin 0.6s cubic-bezier(0.35, 0.14, 0.23, 0.98) infinite;
        box-shadow: 0 26px 40px -24px rgba(37, 99, 235, 0.5),
          inset 2px 2px 6px rgba(255, 255, 255, 0.7),
          inset -3px -5px 10px rgba(96, 165, 250, 0.45);
      }

      .pip {
        width: clamp(12px, 4vw, 18px);
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #fff 0%, #dce3f2 75%, #94a3b8 100%);
        box-shadow: inset -2px -2px 3px rgba(15, 23, 42, 0.3);
        margin: auto;
        opacity: 0;
        transform: scale(0.4);
        transition: opacity 0.18s ease, transform 0.18s ease;
      }

      .pip.visible {
        opacity: 1;
        transform: scale(1);
      }

      .controls {
        display: grid;
        gap: 1rem;
        text-align: center;
      }

      .controls form {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 0.9rem;
      }

      .controls label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-size: 0.95rem;
        color: #475569;
        background: rgba(226, 232, 240, 0.45);
        border-radius: 999px;
        padding: 0.4rem 0.85rem;
      }

      .controls input,
      .controls select {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.55);
        background: rgba(255, 255, 255, 0.92);
        font-size: 1rem;
        padding: 0.45rem 0.8rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        color: #0f172a;
      }

      .controls input:focus,
      .controls select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16);
      }

      .button-row {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      button {
        cursor: pointer;
        padding: 0.85rem 2.75rem;
        border-radius: 999px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        background: var(--primary);
        box-shadow: 0 18px 32px -22px rgba(37, 99, 235, 0.6);
        transition: transform 0.18s ease, box-shadow 0.18s ease,
          background 0.18s ease;
      }

      button.secondary {
        background: #64748b;
        box-shadow: 0 18px 32px -24px rgba(100, 116, 139, 0.5);
      }

      button:hover {
        transform: translateY(-2px);
        background: var(--primary-dark);
        box-shadow: 0 22px 36px -20px rgba(37, 99, 235, 0.65);
      }

      button.secondary:hover {
        background: #4b5563;
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .history {
        margin: 0;
        text-align: center;
        color: #475569;
        font-size: 0.96rem;
      }

      @keyframes roll-spin {
        0% {
          transform: rotate3d(1, 1, 0, 0deg) translateY(0);
        }
        20% {
          transform: rotate3d(1, 1.4, 0.2, 22deg) translateY(-6px);
        }
        40% {
          transform: rotate3d(1, -1.2, -0.3, -18deg) translateY(-4px);
        }
        60% {
          transform: rotate3d(-1.1, 1, 0.1, 18deg) translateY(-6px);
        }
        80% {
          transform: rotate3d(0.9, -1.3, 0.2, -20deg) translateY(-3px);
        }
        100% {
          transform: rotate3d(1, 1, 0, 0deg) translateY(0);
        }
      }

      @media (max-width: 580px) {
        .stats-row {
          grid-template-columns: 30px 50px 1fr 60px;
          gap: 0.6rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="app" aria-live="polite">
      <h1>サイコロシミュレーター</h1>
      <section class="dice-board" aria-label="サイコロの出目"></section>
      <section class="controls">
        <form id="dice-form">
          <label for="dice-count">
            サイコロの数
            <input id="dice-count" name="dice-count" type="number" min="1" max="12" value="2" required />
          </label>
          <label for="dice-type">
            サイコロの種類
            <select id="dice-type" name="dice-type">
              <option value="fair">通常（1〜6）</option>
              <option value="rigged">イカサマ（2,2,3,4,6,6）</option>
            </select>
          </label>
          <button type="submit" id="update-button">反映</button>
        </form>
        <div class="button-row">
          <button type="button" id="roll-button">サイコロを振る</button>
          <button type="button" id="reset-button" class="secondary">統計をリセット</button>
        </div>
        <p class="history" id="history">直近の出目: －</p>
      </section>
      <section class="panel stats-panel">
        <h2>出目の分布</h2>
        <canvas id="stats-chart" aria-label="サイコロの出目ヒストグラム"></canvas>
      </section>
    </main>

    <script>
      const GRID_POSITIONS = {
        topLeft: 1,
        topCenter: 2,
        topRight: 3,
        middleLeft: 4,
        center: 5,
        middleRight: 6,
        bottomLeft: 7,
        bottomCenter: 8,
        bottomRight: 9,
      };

      const STANDARD_PATTERNS = {
        1: [GRID_POSITIONS.center],
        2: [GRID_POSITIONS.topLeft, GRID_POSITIONS.bottomRight],
        3: [GRID_POSITIONS.topLeft, GRID_POSITIONS.center, GRID_POSITIONS.bottomRight],
        4: [GRID_POSITIONS.topLeft, GRID_POSITIONS.topRight, GRID_POSITIONS.bottomLeft, GRID_POSITIONS.bottomRight],
        5: [GRID_POSITIONS.topLeft, GRID_POSITIONS.topRight, GRID_POSITIONS.center, GRID_POSITIONS.bottomLeft, GRID_POSITIONS.bottomRight],
        6: [GRID_POSITIONS.topLeft, GRID_POSITIONS.topRight, GRID_POSITIONS.middleLeft, GRID_POSITIONS.middleRight, GRID_POSITIONS.bottomLeft, GRID_POSITIONS.bottomRight],
      };

      const DIE_DEFINITIONS = {
        fair: {
          faces: [1, 2, 3, 4, 5, 6],
          patterns: STANDARD_PATTERNS,
        },
        rigged: {
          faces: [2, 2, 3, 4, 6, 6],
          patterns: {
            2: STANDARD_PATTERNS[2],
            3: STANDARD_PATTERNS[3],
            4: STANDARD_PATTERNS[4],
            6: STANDARD_PATTERNS[6],
          },
        },
      };

      const diceBoard = document.querySelector(".dice-board");
      const rollButton = document.getElementById("roll-button");
      const resetButton = document.getElementById("reset-button");
      const diceForm = document.getElementById("dice-form");
      const diceCountInput = document.getElementById("dice-count");
      const diceTypeInput = document.getElementById("dice-type");
      const historyLabel = document.getElementById("history");
      const rollStats = new Map([1, 2, 3, 4, 5, 6].map((value) => [value, 0]));
      const chartCanvas = document.getElementById("stats-chart");
      const statsLabels = [1, 2, 3, 4, 5, 6];

      const createPipGrid = (dieElement) => {
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < 9; i += 1) {
          fragment.appendChild(Object.assign(document.createElement("div"), { className: "pip hidden" }));
        }
        dieElement.innerHTML = "";
        dieElement.appendChild(fragment);
      };

      const updateDie = (dieElement, value, patterns) => {
        const pips = dieElement.querySelectorAll(".pip");
        const positions = patterns[value] ?? STANDARD_PATTERNS[value];
        pips.forEach((pip, index) => {
        pip.classList.toggle("visible", positions.includes(index + 1));
        });
        dieElement.setAttribute("aria-label", `サイコロの出目 ${value}`);
      };

      const rollDie = (faces) => faces[Math.floor(Math.random() * faces.length)];

      const getDiceElements = () => Array.from(diceBoard.querySelectorAll(".die"));

      const animateRoll = (faces, patterns, callback) => {
        const frames = 12;
        let frame = 0;
        const diceElements = getDiceElements();
        diceElements.forEach((die) => die.classList.add("is-rolling"));
        const interval = setInterval(() => {
          diceElements.forEach((die) => updateDie(die, rollDie(faces), patterns));
          frame += 1;
          if (frame >= frames) {
            clearInterval(interval);
            diceElements.forEach((die) => die.classList.remove("is-rolling"));
            callback();
          }
        }, 60);
      };

      const updateStats = () => {
        const total = Array.from(rollStats.values()).reduce((sum, count) => sum + count, 0);
        const ctx = chartCanvas.getContext("2d");
        const padding = 28;
        const width = chartCanvas.width - padding * 2;
        const height = chartCanvas.height - padding * 2;
        ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
        ctx.save();
        ctx.translate(padding, padding);
        ctx.fillStyle = "rgba(148, 163, 184, 0.2)";
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = "rgba(37, 99, 235, 0.8)";
        const barWidth = width / statsLabels.length - 16;
        statsLabels.forEach((face, index) => {
          const count = rollStats.get(face) ?? 0;
          const ratio = total > 0 ? count / total : 0;
          const barHeight = height * ratio;
          const x = index * (barWidth + 16) + 8;
          const y = height - barHeight;
          ctx.beginPath();
          ctx.moveTo(x, height);
          ctx.lineTo(x, y + 10);
          ctx.quadraticCurveTo(x, y, x + 10, y);
          ctx.lineTo(x + barWidth - 10, y);
          ctx.quadraticCurveTo(x + barWidth, y, x + barWidth, y + 10);
          ctx.lineTo(x + barWidth, height);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = "#0f172a";
          ctx.font = "14px 'Segoe UI', sans-serif";
          ctx.textAlign = "center";
          ctx.fillText(face, x + barWidth / 2, height + 18);
          ctx.fillText(count, x + barWidth / 2, Math.max(height - barHeight - 8, 14));
          ctx.fillStyle = "rgba(37, 99, 235, 0.8)";
        });
        ctx.restore();
      };

      const performRoll = () => {
        const diceElements = getDiceElements();
        if (diceElements.length === 0) {
          return;
        }
        const type = diceTypeInput.value;
        const { faces, patterns } = DIE_DEFINITIONS[type] ?? DIE_DEFINITIONS.fair;
        rollButton.disabled = true;
        animateRoll(faces, patterns, () => {
          const values = diceElements.map(() => rollDie(faces));
          diceElements.forEach((die, index) => updateDie(die, values[index], patterns));
          historyLabel.textContent = `直近の出目: ${values.join(" + ")}`;
          values.forEach((value) => rollStats.set(value, (rollStats.get(value) ?? 0) + 1));
          updateStats();
          rollButton.disabled = false;
        });
      };

      const rebuildDice = (count) => {
        diceBoard.innerHTML = "";
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < count; i += 1) {
  const die = document.createElement("div");
  die.className = "die";
  die.setAttribute("role", "img");
  die.setAttribute("aria-label", "サイコロの出目 1");
  const face = document.createElement("div");
  face.className = "die-face";
  for (let i = 0; i < 9; i += 1) {
    const cell = document.createElement("div");
    face.appendChild(cell);
  }
  die.appendChild(face);
  createPipGrid(face);
  fragment.appendChild(die);
        }
        diceBoard.appendChild(fragment);
      };

      const updateDiceConfiguration = (event) => {
        event?.preventDefault();
        const count = Number(diceCountInput.value);
        if (!Number.isInteger(count) || count < 1 || count > 12) {
          alert("サイコロの数は 1 〜 12 の整数で指定してください。");
          return;
        }
        rebuildDice(count);
        performRoll();
      };

      const resetStats = () => {
        rollStats.forEach((_, face) => rollStats.set(face, 0));
        updateStats();
      };

      diceForm.addEventListener("submit", updateDiceConfiguration);
      rollButton.addEventListener("click", performRoll);
      resetButton.addEventListener("click", resetStats);

      rebuildDice(Number(diceCountInput.value));
      updateStats();
      performRoll();
    </script>
  </body>
</html>
